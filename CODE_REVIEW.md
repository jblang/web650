# Code Review: IBM 650 Simulator UI

Generated by Claude on commit 1c4e7aa080cb008c271c799d716c665066cfb018. Updated on commit f1e9d468ab882f070346494b156eaa0ad84afe24 to reflect test coverage improvements and echo module removal.

## Project Overview

A web-based UI for the Open SIMH IBM 650 simulator, a historic computer from the mid-1950s. Built with Next.js 16.1.4, React 19.2.3, TypeScript (strict mode), and IBM Carbon Design System. The simulator runs entirely in the browser via WebAssembly, compiled from Open SIMH using Emscripten. A Web Worker (`simh.worker.ts`) hosts the WASM module, and a typed RPC layer (`workerClient.ts`) bridges the main thread. The I650-specific service layer (`src/lib/simh/i650/service.ts`) manages all emulator state via a pub/sub model, with three React context providers (`EmulatorStateProvider`, `EmulatorConsoleProvider`, `EmulatorActionsProvider`) subscribing to it.

**Stats:** ~57 TypeScript/TSX source files, 42 unit test files with 479 tests, 1 Playwright E2E suite (19 tests). v0.1.0 (WIP).

**Test Coverage (unit tests):** 97.78% statements | 91.52% branches | 99.4% functions | 98.93% lines

---

## Summary Priority Matrix

| # | Severity | Issue | Section |
|---|----------|-------|---------|
| 1 | **Medium** | Error handling gaps | [1](#1-error-handling-gaps-medium) |
| 2 | **Medium** | Type safety issues | [2](#2-type-safety-issues-medium) |
| 3 | **Low** | Test coverage gaps | [3](#3-test-coverage-gaps-low) |
| 4 | **Low** | Configuration and build concerns | [4](#4-configuration-and-build-concerns-low) |
| 5 | **Low** | Styling concerns | [5](#5-styling-concerns-low) |

---

## Detailed Findings

### 1. Error Handling Gaps (Medium)

Error handling has improved significantly since the last review (e.g., `EmulatorConsole.tsx` `handleSend` now has `try/finally`, `workerClient.ts` has comprehensive error handling). Remaining gaps:

| File | Line | Issue |
|------|------|-------|
| `CardDeckProvider.tsx` | 41-47 | No `reader.onerror` handler on FileReader. Failed reads give no feedback. |
| `CardDeckProvider.tsx` | 43 | `event.target?.result as string` — unsafe assertion; if `target` is null, calling `.split()` on `undefined` will throw. |
| `docs/page.tsx` | 10-13 | `fetch()` has no `.catch()`, no `response.ok` check, and no loading state. A 404 will set error HTML as page content. |
| `CardDeckProvider.tsx` | 59 | Context `value` object recreated every render (not memoized with `useMemo`). |

---

### 2. Type Safety Issues (Medium)

| File | Line | Issue |
|------|------|-------|
| `DisplaySection.tsx` | 17 | `charAt(10) as '+' \| '-'` — unsafe assertion; returns `''` if string is shorter than 11 characters. |
| `ConfigSection.tsx` | 26 | `export const Error = ErrorSwitch` shadows the global `Error` constructor in the module scope. |
| `ConfigSection.tsx` | 56-59 | Knob `onChange` callbacks use `as ControlPosition`, `as DisplayPosition`, `as ErrorSwitchPosition` — unsafe casts on runtime values from `LabeledKnob`. |
| `programming/page.tsx` | 427 | `header as keyof ProgramRow` — unsafe type assertion on runtime value. |
| `tsconfig.json` | 22 | Path alias `@/*` maps to both `./src/*` and `./node_modules/*` — the `node_modules` mapping can cause unexpected resolution. |

**Recommendation:** Remove `node_modules` from path alias. Rename the `Error` re-export to avoid shadowing.

---

### 3. Test Coverage Gaps (Low)

The test suite has 42 test files with 479 tests, plus 1 Playwright E2E suite (19 tests). Overall coverage is **97.78% statements / 98.93% lines** — a significant improvement from the previous 87.88% / 89.35%.

**Coverage by area:**

| Area | Stmts | Branch | Funcs | Lines | Notes |
|------|-------|--------|-------|-------|-------|
| `components/` | 100% | 95% | 100% | 100% | All component files fully covered |
| `components/FrontPanel/` | 99.45% | 93.67% | 100% | 100% | Decay hooks at 98%+ statements |
| `lib/simh/` (generic) | 96.27% | 89.79% | 100% | 97.98% | `core.ts` at 97.26%, `workerClient.ts` at 98.37% |
| `lib/simh/i650/` | 96.51% | 90.42% | 97.82% | 98.34% | `service.ts` at 95% stmts; all other files at 100% |

**Recent improvements:**
- Added comprehensive tests for React providers (`EmulatorStateProvider`, `EmulatorConsoleProvider`, `EmulatorActionsProvider`)
- Added tests for composite hooks (`useFrontPanelControls`)
- Added tests for presentation layer (`Providers.tsx`, `Header.tsx`, `FrontPanel.tsx`, `DisplaySection.tsx`)
- Added RAF-mocking tests for animation hooks (`useDisplayDecay.ts`, `useDigitDecay.ts`)
- Improved coverage for `workerClient.ts` (79.16% → 89.13% branches), `control.ts` (75% → 100% branches), `service.ts` (69.36% → 83.78% branches)
- Removed `echo.ts` module and associated tests/UI (echo command functionality was redundant)

**Remaining coverage gaps:**

**`useDigitDecay.ts`** (80% branches): Missing test for empty string edge case in decay iteration.

**`useDisplayDecay.ts`** (84.61% branches): Missing edge case tests for decay factor calculations.

**`core.ts`** (91.81% branches): Browser-specific `init()` with DOM script injection and module loading edge cases remain difficult to unit test due to Emscripten/browser dependencies. Current coverage is acceptable given architectural constraints.

**`service.ts`** (83.78% branches): Some complex control flow branches in `handleDrumTransfer` and `startProgramOrTransfer` remain uncovered, but core functionality is thoroughly tested.

---

### 4. Configuration and Build Concerns (Low)

| File | Issue |
|------|-------|
| `package.json` | Inconsistent version pinning: `next`, `react`, `react-dom`, `react-test-renderer`, `babel-plugin-react-compiler` are pinned exact; all other deps use carets. |
| `tsconfig.json` | Target `ES2017` is conservative for React 19 / Next.js 16. `ES2020` or `ES2022` would be more appropriate. |
| `eslint.config.mjs` | `import.meta.dirname` requires Node.js 21.2+. Unsafe TypeScript rules (`no-unsafe-assignment`, etc.) set to `warn` instead of `error`. |
| `layout.tsx` | `suppressHydrationWarning` on both `<html>` and `<body>` may mask real hydration bugs. |
| `layout.tsx` | No React error boundary — any provider crash takes down the entire app. |

---

### 5. Styling Concerns (Low)

| File | Issue |
|------|-------|
| `globals.scss` | 5 uses of `!important` to override Carbon DataTable overflow. Includes `z-index: 9999 !important` which will conflict with modals/overlays. |
| `docs.scss` | Hardcoded dark colors (`#444`, `#333`, `#e0e0e0`, `#e8e8e8`) won't adapt to theme changes. Should use Carbon design tokens. |
| `Knob.module.scss` | Hardcoded colors (`#1a1a1a`, `#2a2a2a`, `#333`). Magic pixel values without documentation. |
| `programming/page.tsx:259` | `paddingBottom: '250px'` magic number, likely a ComboBox overflow workaround. |

---

## Strengths

1. **Client-side WASM architecture with Web Worker isolation.** The emulator runs in a dedicated Web Worker (`simh.worker.ts`), keeping the main thread responsive. The typed RPC layer (`workerClient.ts`) provides clean async APIs with comprehensive error handling (worker errors, message errors, pending-request rejection).

2. **Clean separation of concerns.** Generic SIMH framework code (`src/lib/simh/core.ts`, `control.ts`, `filesystem.ts`) is separated from I650-specific functionality (`src/lib/simh/i650/`). The React layer is split into three focused context providers instead of a monolithic one.

3. **Comprehensive test suite.** 479 tests across 42 files covering unit tests, WASM integration tests (running the real SIMH module in Node.js), and 19 Playwright E2E tests. Overall coverage at **97.78% statements / 98.93% lines / 99.4% functions** with 91.52% branch coverage. Test structure is clean with no duplication, and each handler is tested individually to prevent failure masking. RAF-based animation hooks are tested with realistic frame callbacks, React providers use the probe pattern for state assertions, and the worker RPC layer has comprehensive integration tests in both browser and Node environments.

6. **Accessible front panel.** All indicator bulbs have `role="img"` with descriptive `aria-label` (e.g., `"OVERFLOW: lit"`). Labeled knobs use `role="slider"` with `aria-valuenow`/`aria-valuetext` and full keyboard navigation (arrow keys, Home/End). Decimal knobs use `role="spinbutton"` with arrow key and digit key input. Status panels use `role="group"` with `aria-label`. Control buttons have `type="button"` and `:focus-visible` styles. Blockquote contrast meets WCAG AA.

4. **Live front panel with decay effects.** The state stream + decay system (`useDisplayDecay`, `useDigitDecay`) provides realistic "blinkenlights" behavior, streaming register state from the worker at configurable stride intervals.

5. **React Compiler enabled.** Automatic memoization mitigates the absence of manual `React.memo` calls.

6. **Comprehensive I650 validation.** `format.ts` provides thorough validation functions (`validateWord`, `validateAddress`, `normalizeWord`, `normalizeAddress`) with 32 unit tests covering edge cases.

7. **Consolidated bi-quinary display components.** The `BiQuinaryNumber` component provides a single, well-tested implementation for all bi-quinary encoded digit displays (operation codes, addresses, and data words). Supports both CSS Grid subgrid (for DisplaySection) and `display: contents` flattening (for OperationDisplay/AddressDisplay), eliminating ~60 lines of duplicated rendering logic while maintaining proper grid layout and decay effects.

---

## Files to Prioritize for Improvement

1. **`src/app/docs/page.tsx`** — Add error handling and loading state to fetch
2. **`src/components/CardDeckProvider.tsx`** — Add FileReader error handler and memoize context value
