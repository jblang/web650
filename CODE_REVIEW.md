# Code Review: IBM 650 Simulator UI

Generated by Claude on commit 8de2cadac748099fba74978855994d7f8b848266.

## Project Overview

A web-based UI for the Open SIMH IBM 650 simulator, a historic computer from the mid-1950s. Built with Next.js 16.1.4, React 19.2.3, TypeScript (strict mode), and IBM Carbon Design System. The backend manages a SIMH emulator process via `node-pty` pseudo-terminal, exposed through REST API routes and Server-Sent Events.

**Stats:** 51 TypeScript/TSX source files, ~4,513 lines of production code, 22 test files with ~2,105 lines of test code. 99 tests, all passing. v0.1.0 (WIP).

**Test Coverage:** 85.81% statements | 66.27% branches | 84.57% functions | 86.74% lines

---

## Summary Priority Matrix

| # | Severity | Issue | Section |
|---|----------|-------|---------|
| 1 | **Critical** | No authentication on API endpoints | [1](#1-no-authentication-on-api-endpoints-critical) |
| 2 | **Critical** | Command injection via unsanitized inputs | [2](#2-command-injection-via-unsanitized-inputs-critical) |
| 3 | **High** | Race conditions in emulator lifecycle | [3](#3-race-conditions-in-emulator-lifecycle-high) |
| 4 | **High** | Monolithic context causes excessive re-renders | [4](#4-monolithic-emulatorprovider-context-high) |
| 5 | **High** | Accessibility gaps across the front panel | [5](#5-accessibility-gaps-high) |
| 6 | **Medium** | Missing React.memo and useMemo optimizations | [6](#6-missing-memoization-medium) |
| 7 | **Medium** | Error handling inconsistencies | [7](#7-error-handling-inconsistencies-medium) |
| 8 | **Medium** | Test coverage gaps | [8](#8-test-coverage-gaps-medium) |
| 9 | **Medium** | Type safety issues | [9](#9-type-safety-issues-medium) |
| 10 | **Medium** | Fragile global state pattern | [10](#10-fragile-global-state-pattern-medium) |
| 11 | **Low** | Code duplication and dead code | [11](#11-code-duplication-and-dead-code-low) |
| 12 | **Low** | Configuration and build concerns | [12](#12-configuration-and-build-concerns-low) |
| 13 | **Low** | Styling and theming issues | [13](#13-styling-and-theming-issues-low) |

---

## Detailed Findings

### 1. No Authentication on API Endpoints (Critical)

None of the 13 API routes have any authentication or authorization. Any client with network access can start, stop, restart, or quit the emulator; send arbitrary SIMH commands; read and write register state; and set or clear breakpoints.

For local-only development this may be acceptable, but if deployed to any network-accessible environment, this is a critical security gap.

**Affected:** All files under `src/app/api/`.

**Recommendation:** Add authentication middleware, or at minimum restrict to localhost connections.

---

### 2. Command Injection via Unsanitized Inputs (Critical)

Multiple routes construct SIMH commands by string interpolation with user-supplied input sent over a PTY. Newline characters (`\n`, `\r`) in input could inject additional SIMH commands.

**Affected locations:**
| File | Line | Input Source |
|------|------|-------------|
| `src/app/api/command/route.ts` | 33 | `command` from request body |
| `src/app/api/command/break/[address]/route.ts` | 23, 42 | `address` from URL path |
| `src/app/api/state/[ref]/route.ts` | 22, 44 | `ref` from URL, `value` from body |

**Recommendation:** Validate all inputs against patterns (e.g., `^[0-9]{1,4}$` for addresses, `^[A-Z0-9]+$` for register names). Strip control characters from all user input before passing to the emulator.

---

### 3. Race Conditions in Emulator Lifecycle (High)

The `/api/start` and `/api/restart` endpoints perform multi-step async operations (check state, kill/quit, spawn, store reference) with no locking. Concurrent requests can race: both see the emulator as running, both try to quit, and the global reference ends up inconsistent.

**Affected:**
- `src/app/api/restart/route.ts` (lines 18-34)
- `src/app/api/start/route.ts` (lines 8-24)

**Also:** `src/app/api/escape/route.ts:10` — `sendEscape()` is called but not awaited. Async errors become unhandled promise rejections.

**Recommendation:** Add a mutex or lock around lifecycle operations. Await `sendEscape()` in the escape route.

---

### 4. Monolithic EmulatorProvider Context (High)

`EmulatorProvider.tsx` (733 lines) is a single context provider managing all emulator state: registers, console output, connection status, operating/checking states, configuration switches, breakpoints, and control actions. Every state change re-renders every consumer.

**Specific issues:**
- The `useMemo` dependency array at line 622 is so long it effectively re-creates on nearly every render.
- `operatingState` and `checkingState` (lines 247-267) are initialized with `useState` but their setters are never called — they are effectively static constants wrapped in state. `Object.freeze({ ...operatingState })` creates a new reference each `useMemo` evaluation.
- The command queue (lines 124-151) chains promises manually with `.catch(() => {})` silently swallowing all errors.
- SSE reconnect (lines 687-726) has no exponential backoff or retry limit.

**Recommendation:** Split into multiple focused contexts (e.g., `EmulatorStateContext`, `EmulatorActionsContext`, `EmulatorConsoleContext`). Convert static state to module-level constants.

---

### 5. Accessibility Gaps (High)

The front panel simulation is largely inaccessible to keyboard-only users and screen readers.

**Specific issues:**

| Component | Issue |
|-----------|-------|
| `BiQuinaryDigit.tsx`, `SignDisplay.tsx`, `OperatingStatus.tsx`, `CheckingStatus.tsx` | Emoji-based indicators (lit/unlit bulbs) have no ARIA semantics. Screen readers announce "yellow circle" / "black circle" instead of meaningful state. |
| `DecimalKnob.tsx` | Knob halves are plain `div` elements with `onClick` — not focusable, no keyboard interaction, no `role` attribute. Popup digits likewise. |
| `LabeledKnob.tsx` | Labels are `<span>` with `onClick` but no `tabIndex`, `role`, or `aria-label`. |
| `ControlSection.tsx` | Buttons lack `type="button"` (defaults to `submit`). No keyboard focus indicators in styles. `onMouseLeave` for press state does not handle touch. |
| `PunchedCard.tsx` | Renders 960+ DOM elements per card with no semantic structure. No `role="img"` or `aria-label`. |
| `Header.tsx` | `HeaderName` has `href="#"` instead of `href="/"`. No mobile-responsive hamburger menu for 9+ nav links. |
| `docs.scss` | Blockquote color `#aaa` has ~2.32:1 contrast ratio, failing WCAG AA (minimum 4.5:1). |
| `Knob.scss` | No `:focus` or `:focus-visible` styles on interactive elements. |

**Recommendation:** Add ARIA labels to all interactive elements. Replace emoji indicators with proper visual elements. Implement keyboard navigation for knobs. Add `type="button"` to all control buttons.

---

### 6. Missing Memoization (Medium)

No FrontPanel leaf component uses `React.memo`, and several context values are not memoized. This causes the entire front panel tree to re-render on any state change.

**Affected components missing `React.memo`:**
- `BiQuinaryDigit` (used 16+ times simultaneously)
- `SignDisplay`, `OperatingStatus`, `CheckingStatus`
- `DecimalKnob`, `LabeledKnob`, `Knob`
- `FrontPanel`, `DisplaySection`, `ConfigSection`
- `PunchedCard` (renders 1000+ DOM elements per instance)

**Other memoization issues:**
| File | Line | Issue |
|------|------|-------|
| `CardDeckProvider.tsx` | 59-66 | Context `value` object recreated every render (needs `useMemo`) |
| `EntrySection.tsx` | 73 | `handleDigitChange` curried function creates 10 new closures per render |
| `AddressSelection.tsx` | 15 | Same curried closure issue (4 per render) |
| `EntrySection.tsx` | 61-65 | Derives state from props via `useState` + `useEffect` instead of computing during render |

**Note:** The React Compiler is enabled (`next.config.ts` line 4), which may auto-memoize some of these. However, the compiler cannot fix architectural issues like the monolithic context.

---

### 7. Error Handling Inconsistencies (Medium)

Error handling quality varies across the codebase.

| File | Line | Issue |
|------|------|-------|
| `EmulatorConsole.tsx` | 33-39 | `handleSend` has no try/catch around `sendCommand`. If it throws, the UI stays stuck in "sending" state. |
| `CardDeckProvider.tsx` | 41-47 | No `reader.onerror` handler on FileReader. Failed reads give no feedback. |
| `docs/page.tsx` | 11-13 | `fetch()` has no error handling or loading state. Failed fetch leaves the page blank. |
| `EmulatorProvider.tsx` | 687-726 | SSE reconnect retries every 1s indefinitely with no backoff. |
| API routes (various) | — | Only `state/route.ts` logs error stack traces. Other routes log only the message. |
| `EmulatorProvider.tsx` | 149 | `.catch(() => {})` silently swallows all command queue errors. |
| `escape/route.ts` | 10 | `sendEscape()` not awaited — async errors go unhandled. |

**Recommendation:** Add try/catch with user-visible error feedback to all async operations. Add exponential backoff to SSE reconnection. Log stack traces consistently in API error handlers.

---

### 8. Test Coverage Gaps (Medium)

The test suite is solid overall (85.81% statements, 99 tests) but has specific gaps.

**Missing test files:**
| File | Risk |
|------|------|
| `src/app/api/start/route.ts` | **HIGH** — Critical startup flow with emulator lifecycle management |
| `src/app/api/console/stream/route.ts` | **MEDIUM** — SSE streaming with cleanup logic |

**Missing error path tests:**
- `command/step/route.test.ts` — no 500 error test (only 2 tests vs 3 in `go/`)
- `command/reset/route.test.ts` — no 500 error test
- `escape/route.test.ts` — no 500 error test
- `state/[ref]/route.test.ts` — no 500 error tests for GET or PUT

**Missing edge case tests:**
- `format.test.ts` — no tests for `null`, `undefined`, or overflow inputs
- `simh.test.ts` — no test for `CONSOLE_QUEUE_LIMIT` trimming behavior
- `PunchedCard.test.tsx` — fragile CSS color assertions (`rgb(0, 34, 68)`)

**Structural issues:**
- Duplicated `EmulatorMock` boilerplate across all API route tests — should be extracted to a shared test utility.
- `FrontPanelControls.test.tsx` duplicates tests already in `DecimalKnob.test.tsx`.
- `ConfigSection.test.tsx` tests all 7 handlers in one test — a failure in any handler masks which one failed.
- Inconsistent mock cleanup: some tests use `vi.restoreAllMocks()`, others `vi.clearAllMocks()`.

**Untested components (low risk):** `Header.tsx`, `UIShell.tsx`, `Providers.tsx`, `FrontPanel.tsx`, `DisplaySection.tsx`, `BiQuinaryDigit.tsx`, `SignDisplay.tsx`, `OperatingStatus.tsx`, `CheckingStatus.tsx`, `OperationDisplay.tsx`, `AddressDisplay.tsx`.

---

### 9. Type Safety Issues (Medium)

| File | Line | Issue |
|------|------|-------|
| `src/lib/simh.ts` | 20 | `globalThis as unknown as { __simhShared?: SharedState }` — unsafe double-cast for shared state |
| `src/lib/simh.ts` | 157 | `process.env as Record<string, string>` — ignores that env values can be `undefined` |
| `src/lib/simh.ts` | 549 | `globalThis as unknown as { simhEmulator?: SimhEmulator }` — same unsafe cast pattern |
| `src/app/api/command/route.ts` | 33-37 | `appendCR` and `expectResponse` typed as `unknown` but passed to emulator without boolean validation |
| `src/app/api/command/break/[address]/route.ts` | 4-10 | `Params` union type with `instanceof Promise` check is fragile across Next.js versions |
| `src/components/FrontPanel/ConfigSection.tsx` | 56 | `export const Error = { STOP: 0, SENSE: 1 }` shadows the global `Error` constructor |
| `src/components/FrontPanel/DisplaySection.tsx` | 77 | `charAt(10) as '+' \| '-'` — unsafe assertion; returns `''` if string is short |
| `src/components/FrontPanel/ConfigSection.tsx` | 62-77 | Knob positions typed as `number` instead of specific literal types |
| `src/components/FrontPanel/OperationDisplay.tsx` | 25 | `Number(value)` can produce `NaN`, propagating through `Math.abs` and `.padStart` to produce `"aN"` |
| `src/components/FrontPanel/AddressDisplay.tsx` | 25 | Same NaN propagation issue |
| `src/components/FrontPanel/AddressSelection.tsx` | 11 | Same NaN propagation issue |
| `src/app/programming/page.tsx` | 234 | `as keyof ProgramRow` — unsafe type assertion on runtime value |
| `tsconfig.json` | 22 | Path alias `@/*` maps to both `./src/*` and `./node_modules/*` — the `node_modules` mapping can shadow source modules |

**Recommendation:** Declare proper global types using `declare global {}`. Add NaN guards to all `Number()` conversions. Rename `Error` export to avoid shadowing. Remove `node_modules` from path alias.

---

### 10. Fragile Global State Pattern (Medium)

The emulator singleton is stored on `globalThis` via unsafe casts repeated in 3 files:
- `src/lib/simh.ts:549`
- `src/app/api/restart/route.ts:33-34`
- `src/app/api/start/route.ts:23-24`

Each file independently casts `globalThis` and accesses the magic string property `simhEmulator`. If any file diverges (typo, different property name), the reference becomes inconsistent. The `getEmulator()` function centralizes reads, but writes are done inline in route handlers.

**Recommendation:** Centralize both reads and writes in `src/lib/simh.ts` (e.g., add a `setEmulator()` function). Use `declare global {}` for type-safe access.

---

### 11. Code Duplication and Dead Code (Low)

| Issue | Location | Details |
|-------|----------|---------|
| Dead component | `src/components/UIShell.tsx` | Pure pass-through `<>{children}</>` — does nothing |
| Structural duplication | `OperationDisplay.tsx` + `AddressDisplay.tsx` | Nearly identical except digit count (2 vs 4). Should be parameterized. |
| Route boilerplate | `go/`, `step/`, `reset/` routes | Identical 16-line files differing only by command string |
| Duplicate handlers | `break/[address]/route.ts` | PUT and DELETE are near-identical (28 lines each, differing by `BREAK` vs `NOBREAK`) |
| Repeated guard | All 13 API routes | `if (!emulator?.isRunning()) return 503` pattern is copy-pasted |
| Inconsistent stubs | `punch/page.tsx` | Has `'use client'` while identical stubs `printer/`, `tape/`, `ramac/` do not |

**Recommendation:** Extract shared API helpers for the emulator guard pattern. Parameterize duplicated display components.

---

### 12. Configuration and Build Concerns (Low)

| File | Issue |
|------|-------|
| `package.json` | Missing `engines` field specifying required Node.js version. `node-pty` and React 19 likely require Node.js >= 18. |
| `package.json` | Inconsistent version pinning: `next`, `react`, `react-dom` are pinned exact; other deps use carets. |
| `next.config.ts` | Missing `serverExternalPackages` for `node-pty`. Native modules may have bundling issues. |
| `tsconfig.json` | Target `ES2017` is conservative for React 19. `ES2020` or `ES2022` would be more appropriate. |
| `eslint.config.mjs` | `import.meta.dirname` requires Node.js 21.2+. Unsafe TypeScript rules set to `warn` instead of `error`. |
| `layout.tsx` | `suppressHydrationWarning` on both `<html>` and `<body>` may mask real hydration bugs. |
| `layout.tsx` | No React error boundary — any provider crash takes down the entire app. |

---

### 13. Styling and Theming Issues (Low)

| File | Issue |
|------|-------|
| `globals.scss` | 6 uses of `!important` to override Carbon DataTable overflow. `z-index: 9999 !important` will conflict with modals/overlays. |
| `docs.scss` | Hardcoded dark colors (`#444`, `#333`, `#e0e0e0`, `#e8e8e8`) won't adapt to theme changes. Should use Carbon design tokens. |
| `Knob.scss` | Hardcoded colors (`#1a1a1a`, `#2a2a2a`, `#333`). Magic pixel values (`74.8px`, `90.574px`) without documentation. |
| `FrontPanel.tsx` | Complex 4-layer gradient background in inline styles (lines 59-69) is hard to maintain. |
| `DisplaySection.tsx` | `letterSpacing: '5em'` is extremely fragile — any font size change dramatically alters layout. |
| `programming/page.tsx` | `paddingBottom: '250px'` magic number, likely a ComboBox overflow workaround. |

---

## Strengths

Since the last review, significant progress has been made:

1. **Test suite established.** 22 test files with 99 tests providing 85.81% statement coverage. The `simh.test.ts` file is particularly thorough with 16 test scenarios covering command queuing, parsing, timeouts, and edge cases.

2. **Well-structured SIMH abstraction.** `simh.ts` handles complex PTY communication cleanly: command queuing, prompt detection, output stripping, escape handling, and graceful shutdown with timeout.

3. **Good API patterns.** Consistent error handling structure across routes with proper HTTP status codes (400, 500, 503). Body validation on POST endpoints.

4. **Clean SSE implementation.** `console/stream/route.ts` correctly implements Server-Sent Events with proper cleanup, abort handling, and nginx compatibility headers.

5. **Appropriate use of Next.js features.** App Router, dynamic routes, instrumentation hook for auto-start, `'use client'` directives where needed.

6. **React Compiler enabled.** The experimental React Compiler provides automatic memoization, partially mitigating the missing manual `React.memo` calls.

---

## Files to Prioritize for Improvement

1. **`src/components/EmulatorProvider.tsx`** — Split into multiple contexts, fix static-state-as-useState, add SSE backoff
2. **`src/app/api/start/route.ts`** — Needs test coverage (highest-risk untested file)
3. **`src/app/api/command/break/[address]/route.ts`** + **`state/[ref]/route.ts`** — Input validation to prevent command injection
4. **`src/components/FrontPanel/DecimalKnob.tsx`** + **`LabeledKnob.tsx`** — Add keyboard navigation and ARIA attributes
5. **`src/components/FrontPanel/BiQuinaryDigit.tsx`** — Replace emoji indicators with accessible visual elements
6. **`src/app/api/escape/route.ts`** — Await `sendEscape()` to prevent unhandled rejections
7. **`src/components/FrontPanel/OperationDisplay.tsx`** + **`AddressDisplay.tsx`** — Add NaN guards, consolidate into one component
