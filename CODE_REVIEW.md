# Code Review: IBM 650 Simulator UI

Generated by Claude on commit 8de2cadac748099fba74978855994d7f8b848266. Updated after migration from REST API to client-side WASM architecture.

## Project Overview

A web-based UI for the Open SIMH IBM 650 simulator, a historic computer from the mid-1950s. Built with Next.js 16.1.4, React 19.2.3, TypeScript (strict mode), and IBM Carbon Design System. The simulator runs entirely in the browser via WebAssembly, compiled from Open SIMH using Emscripten. A TypeScript wrapper (`src/lib/simh.ts`) provides the FFI layer over the Emscripten module, and `EmulatorProvider.tsx` manages all emulator state via React context.

**Stats:** ~37 TypeScript/TSX source files, 9 test files with 24 tests. v0.1.0 (WIP).

**Test Coverage (tested files only):** 93.08% statements | 71.95% branches | 89.28% functions | 93.24% lines

Note: Coverage numbers above reflect only files exercised by existing tests. Key files like `simh.ts` and `EmulatorProvider.tsx` are not imported by any test and therefore have 0% coverage but do not appear in the report.

---

## Summary Priority Matrix

| # | Severity | Issue | Section |
|---|----------|-------|---------|
| 1 | ~~**High**~~ | ~~Monolithic context causes excessive re-renders~~ ✅ | [1](#1-monolithic-emulatorprovider-context-high--resolved) |
| 2 | **High** | Accessibility gaps across the front panel | [2](#2-accessibility-gaps-high) |
| 3 | **Medium** | Missing React.memo and useMemo optimizations | [3](#3-missing-memoization-medium) |
| 4 | **Medium** | Error handling inconsistencies | [4](#4-error-handling-inconsistencies-medium) |
| 5 | **Medium** | Test coverage gaps | [5](#5-test-coverage-gaps-medium) |
| 6 | **Medium** | Type safety issues | [6](#6-type-safety-issues-medium) |
| 7 | **Low** | Code duplication and dead code | [7](#7-code-duplication-and-dead-code-low) |
| 8 | **Low** | Configuration and build concerns | [8](#8-configuration-and-build-concerns-low) |
| 9 | **Low** | Styling and theming issues | [9](#9-styling-and-theming-issues-low) |

---

## Detailed Findings

### 1. ~~Monolithic EmulatorProvider Context~~ (High) ✅ **RESOLVED**

**Status:** Fixed in commit [pending]. `EmulatorProvider.tsx` now uses three separate contexts to eliminate unnecessary re-renders.

**Changes made:**
- Split monolithic context into three focused contexts:
  - `EmulatorConsoleContext` — console output and commands (changes frequently during execution)
  - `EmulatorStateContext` — registers, switches, and derived values (changes when registers update)
  - `EmulatorActionsContext` — stable callback references
- Converted `operatingState` and `checkingState` from `useState` to module-level frozen constants (`INITIAL_OPERATING_STATE`, `INITIAL_CHECKING_STATE`)
- Split massive `useMemo` into three separate ones with focused dependency arrays
- Created three hooks: `useEmulatorConsole()`, `useEmulatorState()`, `useEmulatorActions()`
- Updated consumers: `EmulatorConsole.tsx` uses `useEmulatorConsole()`, `useFrontPanelControls.ts` uses `useEmulatorState()` + `useEmulatorActions()`

**Impact:** Console output changes no longer re-render the front panel. Register changes no longer re-render the console. Static state no longer creates new object references on every render.

---

### 2. Accessibility Gaps (High)

The front panel simulation is largely inaccessible to keyboard-only users and screen readers.

**Specific issues:**

| Component | Issue |
|-----------|-------|
| `BiQuinaryDigit.tsx`, `SignDisplay.tsx`, `OperatingStatus.tsx`, `CheckingStatus.tsx` | Emoji-based indicators (lit/unlit bulbs) have no ARIA semantics. Screen readers announce "yellow circle" / "black circle" instead of meaningful state. |
| `DecimalKnob.tsx` | Knob halves are plain `div` elements with `onClick` — not focusable, no keyboard interaction, no `role` attribute. Popup digits likewise. |
| `LabeledKnob.tsx` | Labels are `<span>` with `onClick` but no `tabIndex`, `role`, or `aria-label`. |
| `ControlSection.tsx` | Buttons lack `type="button"` (defaults to `submit`). No keyboard focus indicators in styles. `onMouseLeave` for press state does not handle touch. |
| `PunchedCard.tsx` | Renders 960+ DOM elements per card with no semantic structure. No `role="img"` or `aria-label`. |
| `Header.tsx` | `HeaderName` has `href="#"` instead of `href="/"`. No mobile-responsive hamburger menu for 9+ nav links. |
| `docs.scss` | Blockquote color `#aaa` has ~2.32:1 contrast ratio, failing WCAG AA (minimum 4.5:1). |
| `Knob.scss` | No `:focus` or `:focus-visible` styles on interactive elements. |

**Recommendation:** Add ARIA labels to all interactive elements. Replace emoji indicators with proper visual elements. Implement keyboard navigation for knobs. Add `type="button"` to all control buttons.

---

### 3. Missing Memoization (Medium)

No FrontPanel leaf component uses `React.memo`, and several context values are not memoized. This causes the entire front panel tree to re-render on any state change.

**Affected components missing `React.memo`:**
- `BiQuinaryDigit` (used 16+ times simultaneously)
- `SignDisplay`, `OperatingStatus`, `CheckingStatus`
- `DecimalKnob`, `LabeledKnob`, `Knob`
- `FrontPanel`, `DisplaySection`, `ConfigSection`
- `PunchedCard` (renders 1000+ DOM elements per instance)

**Other memoization issues:**
| File | Line | Issue |
|------|------|-------|
| `CardDeckProvider.tsx` | 59 | Context `value` object recreated every render (needs `useMemo`) |
| `EntrySection.tsx` | 30 | `handleDigitChange` curried function creates 10 new closures per render |
| `AddressSelection.tsx` | 15 | Same curried closure issue (4 per render) |
| `EntrySection.tsx` | 18-22 | Derives state from props via `useState` + `useEffect` instead of computing during render |

**Note:** The React Compiler is enabled (`next.config.ts` line 4), which may auto-memoize some of these. However, the compiler cannot fix architectural issues like the monolithic context.

---

### 4. Error Handling Inconsistencies (Medium)

Error handling quality varies across the codebase.

| File | Line | Issue |
|------|------|-------|
| `EmulatorConsole.tsx` | 33-38 | `handleSend` has no try/catch around `sendCommand`. If it throws, the UI stays stuck in "sending" state. |
| `EmulatorProvider.tsx` | 303-308 | `refreshRegisters()` not awaited inside `startRunning` callback — could race with `setIsRunning(false)`. |
| `EmulatorProvider.tsx` | 470 | `refreshRegisters()` not awaited during initialization — UI briefly renders with stale defaults. |
| `useFrontPanelControls.ts` | 49 | `refreshRegisters()` errors silently logged to console — user gets no feedback on register refresh failures. |
| `CardDeckProvider.tsx` | 41-46 | No `reader.onerror` handler on FileReader. Failed reads give no feedback. |
| `CardDeckProvider.tsx` | 43 | `event.target?.result as string` — unsafe assertion; if `target` is null, `text` will be `undefined` despite the cast. |
| `docs/page.tsx` | 11-13 | `fetch()` has no error handling, no loading state, and doesn't check `response.ok`. A 404 will set error HTML as page content. |

**Recommendation:** Add try/catch with user-visible error feedback to all async operations. Await all async calls consistently.

---

### 5. Test Coverage Gaps (Medium)

The test suite has 9 test files with 24 tests. Coverage of tested files is strong (93% statements), but key files are entirely untested.

**Current coverage by file:**
| File | Stmts | Branch | Funcs | Lines | Uncovered |
|------|-------|--------|-------|-------|-----------|
| `CardDeckProvider.tsx` | 90.6% | 78.6% | 100% | 90% | 19, 35-36 |
| `EmulatorConsole.tsx` | 83.3% | 50% | 83.3% | 87% | 43-45 |
| `PunchedCard.tsx` | 100% | 90% | 100% | 100% | 86 |
| `AddressSelection.tsx` | 100% | 100% | 100% | 100% | — |
| `ConfigSection.tsx` | 100% | 100% | 100% | 100% | — |
| `ControlSection.tsx` | 76.9% | 100% | 50% | 76.9% | 54-56 |
| `DecimalKnob.tsx` | 87.5% | 61.1% | 91.7% | 86.8% | 38-39, 53, 55, 60 |
| `EntrySection.tsx` | 100% | 50% | 100% | 100% | 26-42 |
| `Knob.tsx` | 100% | 100% | 100% | 100% | — |
| `LabeledKnob.tsx` | 96.6% | 83.3% | 83.3% | 96.6% | 59 |
| `format.ts` | 94.4% | 87.5% | 100% | 94.4% | 6 |

**Files with 0% coverage (not in report):**
| File | Risk |
|------|------|
| `EmulatorProvider.tsx` | **HIGH** — Central state management with ~490 lines of register sync, display derivation, and control flow logic |
| `simh.ts` | **HIGH** — Core WASM integration with ~318 lines including output parsing and capture logic |

**`src/lib/simh.ts` — testability analysis:**

The Emscripten-compiled module (`public/i650.js`) exports `createI650Module` via CommonJS `module.exports` and includes Node.js code paths for loading `.wasm` and `.data` files. This means the full WASM emulator can be loaded and tested in Node.js/Vitest without a browser — `simh_init`, `simh_cmd`, `simh_step`, `EXAMINE`, `DEPOSIT`, and filesystem operations all work.

The wrapper code falls into two categories:

| Category | Functions | Strategy |
|----------|-----------|----------|
| Pure logic (currently module-private) | `parseKeyValues` — parses SIMH EXAMINE output into key-value pairs, with AR truncation logic. `getDisplayValue` in `EmulatorProvider.tsx` — maps display switch to register. | Export and unit test directly. |
| Browser-specific glue | `init` (DOM script injection), `startRunning`/`stopRunning` (`requestAnimationFrame` tick loop) | Not testable in Node.js as-is. Could be made testable by refactoring `init` to accept an injected module instance, and replacing `requestAnimationFrame` with a pluggable scheduler. |
| WASM integration logic | `sendCommand`, `examineState`, `depositState`, `step`, output capture (`beginCapture`/`endCapture`/`handleOutput`), filesystem ops | Testable in Node.js if the wrapper is refactored to decouple module loading from module usage. Alternatively, integration tests can call `createI650Module` directly and test the SIMH C API via `ccall`. |

**`EmulatorProvider.tsx` — testability analysis:**

The provider's React logic (register state management, display derivation, control flow for program start/stop/reset, manual drum operations) can be tested by mocking the `@/lib/simh` module. This would cover the most important behavior: how UI actions map to emulator operations and how register state is synchronized.

**Recommended test priorities:**
1. Export `parseKeyValues` from `simh.ts` and add unit tests (parsing edge cases: empty input, malformed lines, multi-digit AR truncation, mixed case)
2. Add integration tests that load the WASM module directly in Node.js via `require('./public/i650.js')` to test command execution, register examine/deposit, stepping, and filesystem operations
3. Add `EmulatorProvider` tests with `simh` mocked via `vi.mock` (register refresh, display switch derivation, program start/stop/reset flows, manual drum read-out/write-in)
4. Consider refactoring `simh.ts` to accept an injected module instance, enabling the wrapper's integration logic (output capture, command execution) to be tested against the real WASM module in Node.js

**Missing edge case tests:**
- `format.test.ts` — no tests for `null`, `undefined`, or overflow inputs
- `PunchedCard.test.tsx` — fragile CSS color assertions (`rgb(0, 34, 68)`)

**Structural issues:**
- `FrontPanelControls.test.tsx` duplicates tests already in `DecimalKnob.test.tsx`.
- `ConfigSection.test.tsx` tests all 7 handlers in one test — a failure in any handler masks which one failed.
- Inconsistent mock cleanup: some tests use `vi.restoreAllMocks()`, others `vi.clearAllMocks()`.

**Untested components (low risk):** `Header.tsx`, `UIShell.tsx`, `Providers.tsx`, `FrontPanel.tsx`, `DisplaySection.tsx`, `BiQuinaryDigit.tsx`, `SignDisplay.tsx`, `OperatingStatus.tsx`, `CheckingStatus.tsx`, `OperationDisplay.tsx`, `AddressDisplay.tsx`.

---

### 6. Type Safety Issues (Medium)

| File | Line | Issue |
|------|------|-------|
| `src/components/FrontPanel/ConfigSection.tsx` | 58 | `export const Error = { STOP: 0, SENSE: 1 }` shadows the global `Error` constructor |
| `src/components/FrontPanel/DisplaySection.tsx` | 14 | `charAt(10) as '+' \| '-'` — unsafe assertion; returns `''` if string is short |
| `src/components/FrontPanel/ConfigSection.tsx` | 62-77 | Knob positions typed as `number` instead of specific literal types |
| `src/components/FrontPanel/OperationDisplay.tsx` | 11 | `Number(value)` can produce `NaN`, propagating through `Math.abs` and `.padStart` to produce `"aN"` |
| `src/components/FrontPanel/AddressDisplay.tsx` | 11 | Same NaN propagation issue |
| `src/components/FrontPanel/AddressSelection.tsx` | 11 | Same NaN propagation issue |
| `src/app/programming/page.tsx` | 234 | `as keyof ProgramRow` — unsafe type assertion on runtime value |
| `tsconfig.json` | 22 | Path alias `@/*` maps to both `./src/*` and `./node_modules/*` — the `node_modules` mapping can shadow source modules |

**Recommendation:** Add NaN guards to all `Number()` conversions. Rename `Error` export to avoid shadowing. Remove `node_modules` from path alias.

---

### 7. Code Duplication and Dead Code (Low)

| Issue | Location | Details |
|-------|----------|---------|
| Dead component | `src/components/UIShell.tsx` | Pure pass-through `<>{children}</>` — does nothing |
| Structural duplication | `OperationDisplay.tsx` + `AddressDisplay.tsx` | Nearly identical except digit count (2 vs 4). Should be parameterized. |
| Repeated padding logic | `AddressDisplay.tsx:11`, `AddressSelection.tsx:11`, `OperationDisplay.tsx:11` | Same `String(Math.abs(Number(value))).padStart(N, '0').slice(-N)` in 3 files — extract to `format.ts` |
| Empty stub handlers | `EmulatorProvider.tsx:371-373` | `onHelpClick` and `onCheatClick` are no-op `useCallback(() => {}, [])` — buttons are wired up but do nothing |
| Inconsistent stubs | `punch/page.tsx` | Has `'use client'` while identical stubs `printer/`, `tape/`, `ramac/` do not |

**Recommendation:** Remove `UIShell.tsx`. Parameterize duplicated display components. Extract shared formatting logic.

---

### 8. Configuration and Build Concerns (Low)

| File | Issue |
|------|-------|
| `package.json` | Inconsistent version pinning: `next`, `react`, `react-dom` are pinned exact; other deps use carets. |
| `tsconfig.json` | Target `ES2017` is conservative for React 19. `ES2020` or `ES2022` would be more appropriate. |
| `eslint.config.mjs` | `import.meta.dirname` requires Node.js 21.2+. Unsafe TypeScript rules set to `warn` instead of `error`. |
| `layout.tsx` | `suppressHydrationWarning` on both `<html>` and `<body>` may mask real hydration bugs. |
| `layout.tsx` | No React error boundary — any provider crash takes down the entire app. |

---

### 9. Styling and Theming Issues (Low)

| File | Issue |
|------|-------|
| `globals.scss` | 6 uses of `!important` to override Carbon DataTable overflow. `z-index: 9999 !important` will conflict with modals/overlays. |
| `docs.scss` | Hardcoded dark colors (`#444`, `#333`, `#e0e0e0`, `#e8e8e8`) won't adapt to theme changes. Should use Carbon design tokens. |
| `Knob.scss` | Hardcoded colors (`#1a1a1a`, `#2a2a2a`, `#333`). Magic pixel values (`74.8px`, `90.574px`) without documentation. |
| `FrontPanel.tsx` | Complex 4-layer gradient background in inline styles is hard to maintain. |
| `DisplaySection.tsx` | `letterSpacing: '5em'` is extremely fragile — any font size change dramatically alters layout. |
| `programming/page.tsx` | `paddingBottom: '250px'` magic number, likely a ComboBox overflow workaround. |

---

## Strengths

1. **Client-side WASM architecture.** The migration from a server-side PTY/REST API to client-side WebAssembly eliminates network latency, removes server-side security concerns (command injection, unauthenticated endpoints), and enables deployment as a static site.

2. **Clean WASM abstraction.** `simh.ts` provides a well-structured wrapper over Emscripten: output capture, register access via `examineState`/`depositState`, virtual filesystem support, and a `requestAnimationFrame`-based tick loop for smooth 60fps execution.

3. **React Compiler enabled.** The React Compiler provides automatic memoization, partially mitigating the missing manual `React.memo` calls.

4. **Appropriate use of Next.js features.** App Router, `'use client'` directives where needed, static page generation for all routes.

---

## Files to Prioritize for Improvement

1. **`src/lib/simh.ts`** — Export `parseKeyValues` and add unit tests for parsing logic
2. **`src/components/EmulatorProvider.tsx`** — Add tests with mocked simh; split into multiple contexts; fix static-state-as-useState
3. **`src/components/FrontPanel/DecimalKnob.tsx`** + **`LabeledKnob.tsx`** — Add keyboard navigation and ARIA attributes
4. **`src/components/FrontPanel/BiQuinaryDigit.tsx`** — Replace emoji indicators with accessible visual elements
5. **`src/components/FrontPanel/OperationDisplay.tsx`** + **`AddressDisplay.tsx`** — Add NaN guards, consolidate into one component
