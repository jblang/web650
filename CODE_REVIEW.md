# Code Review: simh-ui (IBM 650 Simulator UI)

Generated by Claude on commit 7dfcdce1a38d11959ce86baa691f70388b432d67.

## Project Overview

This is a web-based UI for the Open SIMH IBM 650 simulator - a historic computer from the mid-1950s. The project uses Next.js 16.1.4, React 19.2.3, TypeScript, and IBM Carbon Design System.

**Stats:** 35 TypeScript/TSX files, ~2,479 lines of code, v0.1.0 (WIP)

---

## Major Areas for Improvement

### 1. No Test Coverage (Critical)

**Severity: Critical**

No test files exist in the entire project. No test framework is configured.

**Impact:**
- No quality assurance for refactoring
- Regressions go undetected
- Difficult to verify behavior of emulator integration

**Recommendation:** Set up Vitest or Jest with React Testing Library. Priority areas:
- `src/lib/simh.ts` - Core emulator logic
- `src/app/api/` routes - API behavior
- Provider components - State management

---

### 2. Missing Code Documentation (High)

**Severity: High**

Zero JSDoc comments found in the codebase. Complex logic lacks inline explanations.

**Affected files:**
- `src/lib/simh.ts` - No documentation for `SimhEmulator` class or methods
- `src/components/FrontPanel.tsx` - Complex component with 10 state variables, no comments
- `src/app/api/command/route.ts` - No API documentation

**Recommendation:** Add JSDoc to:
- All exported functions and classes
- Complex logic sections
- API request/response formats

---

### 3. TypeScript Type Safety Issues (High)

**Severity: High**

Unsafe type casting patterns that defeat TypeScript's protection.

**Issues:**
- `src/app/api/start/route.ts:17` - `globalThis as unknown as { simhEmulator?: SimhEmulator }`
- `src/lib/simh.ts:135` - Same unsafe casting pattern
- `src/lib/simh.ts:40` - `process.env as Record<string, string>` ignores undefined values

**Recommendation:**
- Declare proper global types using `declare global { }`
- Create typed utility for environment variables with validation
- Remove `unknown` intermediate casts

---

### 4. Inconsistent Error Handling (High)

**Severity: High**

Error handling varies widely across the codebase.

**Issues:**
- **Silent failures:** `src/components/CardDeckProvider.tsx:35` - console.error but no user feedback
- **Unhandled promise rejections:** `src/components/EmulatorConsole.tsx:32-57` - fetch() without response.ok check
- **Generic messages:** `src/lib/simh.ts:44` - "Failed to spawn" doesn't distinguish failure reasons
- **Missing cleanup:** `src/components/EmulatorProvider.tsx:51` - useEffect has no cleanup function

**Recommendation:**
- Create consistent error handling utilities
- Always check `response.ok` before parsing JSON
- Add useEffect cleanup functions to prevent memory leaks

---

### 5. Accessibility Gaps (High)

**Severity: High**

Only 2 `aria-` attributes in the entire codebase (both in Header.tsx).

**Issues:**
- `src/components/ControlSection.tsx` - Buttons lack aria-labels
- `src/components/DecimalKnob.tsx` - Custom controls have no keyboard navigation
- `src/components/FrontPanel.tsx` - Complex control panel inaccessible to screen readers
- No alt text for visual elements representing physical controls

**Recommendation:**
- Add aria-labels to all interactive elements
- Implement keyboard navigation for custom controls
- Add screen reader descriptions for the front panel

---

### 6. Code Duplication (~100+ lines) (Medium)

**Severity: Medium**

Several patterns are duplicated across components.

**Major duplications:**
| Location | Duplication | Lines |
|----------|-------------|-------|
| `DecimalKnob.tsx` + `LabeledKnob.tsx` | SVG knob rendering | ~40 |
| `DecimalKnob.tsx` + `LabeledKnob.tsx` | Cursor URL definitions | ~5 |
| `OperatingStatus.tsx` + `CheckingStatus.tsx` | LED style objects | ~20 |
| 3 API/Provider files | Error message extraction | ~15 |

**Recommendation:**
- Extract shared `<KnobSVG>` component or `useKnobSVG()` hook
- Create `src/lib/constants.ts` for cursors
- Create shared styles for LED components
- Create `getErrorMessage(error: unknown)` utility

---

### 7. State Management / Prop Drilling (Medium)

**Severity: Medium**

Components receive excessive props and state is fragmented.

**Issues:**
- `src/components/ConfigSection.tsx:20-36` - Receives 13 props (7 values + 7 handlers)
- `src/components/FrontPanel.tsx:41-51` - 10 separate useState calls for related state
- `src/components/CardDeckProvider.tsx:59` - Context value object recreated every render (needs useMemo)
- `src/app/program/page.tsx:69` - Arrays recreated on every render without memoization

**Recommendation:**
- Consolidate related state into single objects
- Use `useMemo` for context values
- Consider extracting FrontPanel state into its own context

---

### 8. Separation of Concerns (Medium)

**Severity: Medium**

Some components mix UI rendering with business logic.

**Issues:**
- `src/components/CardDeckProvider.tsx:28-52` - File parsing logic embedded in provider
- `src/app/program/page.tsx` - 252 lines mixing state, drag-drop, row management, and rendering

**Recommendation:**
- Extract file parsing to `src/lib/fileParser.ts`
- Create custom hooks: `useProgramTable()`, `useTableDragDrop()`

---

### 9. Performance Concerns (Medium)

**Severity: Medium**

Several patterns could cause performance issues over time.

**Issues:**
- `src/lib/simh.ts:11` - `outputBuffer` grows unbounded, never cleared on errors
- `src/components/EmulatorProvider.tsx:29` - String concatenation with `prev + text` for large outputs
- `src/components/DecimalKnob.tsx:141-156` - Recreates digit array `[0-9]` on every render

**Recommendation:**
- Add maximum buffer size limits
- Use useEffect cleanup for EmulatorProvider
- Memoize static arrays

---

### 10. Missing Infrastructure (Low)

**Severity: Low**

- `package.json` references `scripts/parse-ini.js` which doesn't exist
- `src/components/UIShell.tsx` is a pass-through component that adds no value
- 6 console.log/error statements that should use proper logging in production

---

## Summary Priority Matrix

| Priority | Issue | Action |
|----------|-------|--------|
| **Critical** | No tests | Set up Vitest + RTL |
| **High** | Type safety | Fix unsafe casts |
| **High** | Error handling | Add consistent patterns |
| **High** | Accessibility | Add aria labels + keyboard nav |
| **High** | Documentation | Add JSDoc comments |
| **Medium** | Code duplication | Extract shared components |
| **Medium** | State management | Memoize + consolidate |
| **Medium** | Separation of concerns | Extract to hooks/utils |
| **Low** | Missing scripts | Clean up package.json |

---

## Files to Prioritize for Improvement

1. `src/lib/simh.ts` - Core logic, needs types, docs, error handling
2. `src/components/EmulatorProvider.tsx` - Needs cleanup, error handling
3. `src/components/DecimalKnob.tsx` + `LabeledKnob.tsx` - Consolidate duplicated code
4. `src/app/api/start/route.ts` + `command/route.ts` - Type safety fixes
5. `src/components/FrontPanel.tsx` - Accessibility, state consolidation
