# Code Review: IBM 650 Simulator UI

Generated by Claude on commit 1c4e7aa080cb008c271c799d716c665066cfb018.

## Project Overview

A web-based UI for the Open SIMH IBM 650 simulator, a historic computer from the mid-1950s. Built with Next.js 16.1.4, React 19.2.3, TypeScript (strict mode), and IBM Carbon Design System. The simulator runs entirely in the browser via WebAssembly, compiled from Open SIMH using Emscripten. A Web Worker (`simh.worker.ts`) hosts the WASM module, and a typed RPC layer (`workerClient.ts`) bridges the main thread. The I650-specific service layer (`src/lib/simh/i650/service.ts`) manages all emulator state via a pub/sub model, with three React context providers (`EmulatorStateProvider`, `EmulatorConsoleProvider`, `EmulatorActionsProvider`) subscribing to it.

**Stats:** ~57 TypeScript/TSX source files, 24 unit test files with 201 tests, 1 Playwright E2E suite. v0.1.0 (WIP).

**Test Coverage (unit tests):** 87.88% statements | 81.51% branches | 92.51% functions | 89.35% lines

---

## Summary Priority Matrix

| # | Severity | Issue | Section |
|---|----------|-------|---------|
| 1 | **High** | Accessibility gaps across the front panel | [1](#1-accessibility-gaps-high) |
| 2 | **Medium** | Error handling gaps | [2](#2-error-handling-gaps-medium) |
| 3 | **Medium** | Type safety issues | [3](#3-type-safety-issues-medium) |
| 4 | **Medium** | Test coverage gaps | [4](#4-test-coverage-gaps-medium) |
| 5 | **Low** | Code duplication and dead code | [5](#5-code-duplication-and-dead-code-low) |
| 6 | **Low** | Configuration and build concerns | [6](#6-configuration-and-build-concerns-low) |
| 7 | **Low** | Styling concerns | [7](#7-styling-concerns-low) |

---

## Detailed Findings

### 1. Accessibility Gaps (High)

The front panel simulation is largely inaccessible to keyboard-only users and screen readers. While `Bulb.tsx` was introduced to centralize indicator rendering, it still uses emoji characters (`ðŸŸ¡`/`âš«`) with no ARIA semantics.

**Specific issues:**

| Component | Issue |
|-----------|-------|
| `Bulb.tsx` | Renders emoji `ðŸŸ¡`/`âš«` as `<span>` with no `role`, `aria-label`, or text alternative. Screen reader output varies by platform. |
| `BiQuinaryDigit.tsx`, `SignDisplay.tsx` | Use `Bulb` but add no ARIA attributes or `role` to describe what the indicator represents. |
| `OperatingStatus.tsx`, `CheckingStatus.tsx` | Status labels are plain `<div>` text with no semantic association to their corresponding `Bulb` indicators. No `role="group"` or `aria-live` for state changes. |
| `DecimalKnob.tsx` | Knob halves are `<div>` elements with `onClick` â€” not focusable (no `tabIndex`), no keyboard interaction, no `role` or `aria-label`. Popup digits likewise not keyboard-accessible. |
| `LabeledKnob.tsx` | Labels are `<span>` with `onClick` but no `tabIndex`, `role`, or `aria-label`. |
| `ControlSection.tsx` | Buttons lack `type="button"` (defaults to `submit` in form context). Uses `onMouseDown`/`onMouseUp`/`onMouseLeave` for press effect but no touch event handlers. |
| `PunchedCard.tsx` | Renders 960+ DOM elements per card with no `role="img"` or `aria-label`. |
| `Header.tsx` | `HeaderName` has `href="#"` instead of `href="/"`. |
| `docs.scss` | Blockquote color `#aaa` has ~2.32:1 contrast ratio, failing WCAG AA (minimum 4.5:1). |
| `Knob.module.scss` | No `:focus` or `:focus-visible` styles on any interactive element. |

**Recommendation:** Add ARIA labels and roles to all interactive and indicator elements. Implement keyboard navigation for knobs (`tabIndex`, arrow key handlers). Add `type="button"` to control buttons. Add focus indicator styles to `Knob.module.scss`.

---

### 2. Error Handling Gaps (Medium)

Error handling has improved significantly since the last review (e.g., `EmulatorConsole.tsx` `handleSend` now has `try/finally`, `workerClient.ts` has comprehensive error handling). Remaining gaps:

| File | Line | Issue |
|------|------|-------|
| `CardDeckProvider.tsx` | 41-47 | No `reader.onerror` handler on FileReader. Failed reads give no feedback. |
| `CardDeckProvider.tsx` | 43 | `event.target?.result as string` â€” unsafe assertion; if `target` is null, calling `.split()` on `undefined` will throw. |
| `docs/page.tsx` | 10-13 | `fetch()` has no `.catch()`, no `response.ok` check, and no loading state. A 404 will set error HTML as page content. |
| `CardDeckProvider.tsx` | 59 | Context `value` object recreated every render (not memoized with `useMemo`). |

---

### 3. Type Safety Issues (Medium)

| File | Line | Issue |
|------|------|-------|
| `DisplaySection.tsx` | 17 | `charAt(10) as '+' \| '-'` â€” unsafe assertion; returns `''` if string is shorter than 11 characters. |
| `OperationDisplay.tsx` | 13 | `Number(value)` can produce `NaN`, propagating through `Math.abs` and `.padStart` to produce `"aN"`. |
| `AddressDisplay.tsx` | 13 | Same `NaN` propagation issue as `OperationDisplay.tsx`. |
| `AddressSelection.tsx` | 11 | Same `NaN` propagation issue. |
| `ConfigSection.tsx` | 26 | `export const Error = ErrorSwitch` shadows the global `Error` constructor in the module scope. |
| `ConfigSection.tsx` | 56-59 | Knob `onChange` callbacks use `as ControlPosition`, `as DisplayPosition`, `as ErrorSwitchPosition` â€” unsafe casts on runtime values from `LabeledKnob`. |
| `programming/page.tsx` | 427 | `header as keyof ProgramRow` â€” unsafe type assertion on runtime value. |
| `tsconfig.json` | 22 | Path alias `@/*` maps to both `./src/*` and `./node_modules/*` â€” the `node_modules` mapping can cause unexpected resolution. |

**Recommendation:** Add `NaN` guards to all `Number()` conversions in display components. Remove `node_modules` from path alias. Rename the `Error` re-export to avoid shadowing.

---

### 4. Test Coverage Gaps (Medium)

The test suite has grown substantially: 24 test files with 201 tests, plus 1 Playwright E2E suite. Overall coverage is 87.88% statements / 89.35% lines.

**Coverage by area:**

| Area | Stmts | Branch | Funcs | Lines | Notes |
|------|-------|--------|-------|-------|-------|
| `components/` | 100% | 95.65% | 100% | 100% | All tested component files at or near 100% |
| `components/FrontPanel/` | 100% | 100% | 100% | 100% | Leaf components fully covered |
| `lib/simh/` (generic) | 81.23% | 74.75% | 86.02% | 83.29% | `core.ts` at 75.79%, `workerClient.ts` at 83.84% |
| `lib/simh/i650/` | 87.66% | 81.91% | 93.47% | 89.22% | `service.ts` at 82.3% stmts; all other files at 100% |

**Key uncovered areas in `core.ts`** (75.79% statements): Browser-specific `init()` with DOM script injection, module loading, state stream ring buffer read paths. These are inherently hard to unit test due to Emscripten/browser dependencies.

**Key uncovered areas in `service.ts`** (82.3% statements): `postInit` callbacks (state stream startup, yield steps persistence), `handleDrumTransfer`, `startProgramOrTransfer` control flow, `resetAccumulator`, `transferAddress`.

**Untested provider/component files (0% coverage, not in report):**
- `EmulatorStateProvider.tsx`, `EmulatorConsoleProvider.tsx`, `EmulatorActionsProvider.tsx` â€” React providers wrapping the `i650/service` module
- `useFrontPanelControls.ts` â€” Hook connecting providers to `FrontPanel`
- `Providers.tsx`, `Header.tsx`, `UIShell.tsx`, `FrontPanel.tsx`
- Display components: `BiQuinaryDigit.tsx`, `SignDisplay.tsx`, `OperatingStatus.tsx`, `CheckingStatus.tsx`, `DisplaySection.tsx`
- Decay hooks: `useDisplayDecay.ts`, `useDigitDecay.ts`

**Structural issues:**
- `FrontPanelControls.test.tsx` duplicates tests already in `DecimalKnob.test.tsx`.
- `ConfigSection.test.tsx` tests all 7 handlers in one test â€” a failure in any handler masks which one failed.

---

### 5. Code Duplication and Dead Code (Low)

| Issue | Location | Details |
|-------|----------|---------|
| Dead component | `src/components/UIShell.tsx` | Pure pass-through `<>{children}</>` â€” does nothing. Only imported by `src/app/emulator/page.tsx`. |
| Structural duplication | `OperationDisplay.tsx` + `AddressDisplay.tsx` | Nearly identical: both take `value` + `tick`, convert via `Number`/`padStart`/`slice`, render `BiQuinaryDigit` cells with `useDigitDecay`. Differ only in digit count (2 vs 4) and title text. |
| Repeated padding logic | `AddressDisplay.tsx:13`, `AddressSelection.tsx:11`, `OperationDisplay.tsx:13` | Same `String(Math.abs(Number(value))).padStart(N, '0').slice(-N)` pattern in 3 files. |
| Empty stub handlers | `EmulatorActionsProvider.tsx:124-126` | `onHelpClick` and `onCheatClick` are no-op `useCallback(() => {}, [])` â€” buttons are wired up but do nothing. |

---

### 6. Configuration and Build Concerns (Low)

| File | Issue |
|------|-------|
| `package.json` | Inconsistent version pinning: `next`, `react`, `react-dom`, `react-test-renderer`, `babel-plugin-react-compiler` are pinned exact; all other deps use carets. |
| `tsconfig.json` | Target `ES2017` is conservative for React 19 / Next.js 16. `ES2020` or `ES2022` would be more appropriate. |
| `eslint.config.mjs` | `import.meta.dirname` requires Node.js 21.2+. Unsafe TypeScript rules (`no-unsafe-assignment`, etc.) set to `warn` instead of `error`. |
| `layout.tsx` | `suppressHydrationWarning` on both `<html>` and `<body>` may mask real hydration bugs. |
| `layout.tsx` | No React error boundary â€” any provider crash takes down the entire app. |

---

### 7. Styling Concerns (Low)

| File | Issue |
|------|-------|
| `globals.scss` | 5 uses of `!important` to override Carbon DataTable overflow. Includes `z-index: 9999 !important` which will conflict with modals/overlays. |
| `docs.scss` | Hardcoded dark colors (`#444`, `#333`, `#e0e0e0`, `#e8e8e8`) won't adapt to theme changes. Should use Carbon design tokens. |
| `Knob.module.scss` | Hardcoded colors (`#1a1a1a`, `#2a2a2a`, `#333`). Magic pixel values without documentation. |
| `programming/page.tsx:259` | `paddingBottom: '250px'` magic number, likely a ComboBox overflow workaround. |

---

## Strengths

1. **Client-side WASM architecture with Web Worker isolation.** The emulator runs in a dedicated Web Worker (`simh.worker.ts`), keeping the main thread responsive. The typed RPC layer (`workerClient.ts`) provides clean async APIs with comprehensive error handling (worker errors, message errors, pending-request rejection).

2. **Clean separation of concerns.** Generic SIMH framework code (`src/lib/simh/core.ts`, `control.ts`, `filesystem.ts`) is separated from I650-specific functionality (`src/lib/simh/i650/`). The React layer is split into three focused context providers instead of a monolithic one.

3. **Strong test suite.** 201 tests across 24 files covering unit tests, WASM integration tests (running the real SIMH module in Node.js), and Playwright E2E tests. Overall coverage at ~88% statements.

4. **Live front panel with decay effects.** The state stream + decay system (`useDisplayDecay`, `useDigitDecay`) provides realistic "blinkenlights" behavior, streaming register state from the worker at configurable stride intervals.

5. **React Compiler enabled.** Automatic memoization mitigates the absence of manual `React.memo` calls.

6. **Comprehensive I650 validation.** `format.ts` provides thorough validation functions (`validateWord`, `validateAddress`, `normalizeWord`, `normalizeAddress`) with 32 unit tests covering edge cases.

---

## Files to Prioritize for Improvement

1. **`src/components/FrontPanel/DecimalKnob.tsx`** + **`LabeledKnob.tsx`** â€” Add keyboard navigation and ARIA attributes
2. **`src/components/FrontPanel/Bulb.tsx`** â€” Replace emoji indicators with accessible visual elements (CSS circles or SVG)
3. **`src/components/FrontPanel/OperationDisplay.tsx`** + **`AddressDisplay.tsx`** â€” Add NaN guards; consider consolidating into one parameterized component
4. **`src/app/docs/page.tsx`** â€” Add error handling and loading state to fetch
5. **`src/components/CardDeckProvider.tsx`** â€” Add FileReader error handler and memoize context value
